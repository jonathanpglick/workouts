<!DOCTYPE html>
<html>
<head>
  <title>Core Circuit B</title>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
  <script type="text/javascript">

    var exercises = [
      '4 point plank',
      '2 foot jump',
      '3 point plank (L Foot)',
      'L foot jump',
      '3 point plank (R Foot)',
      'R foot jump',
      '3 point plank (L Hand)',
      'RL foot jump',
      '3 point plank (R Hand)',
      'R foot jump',
      '2 point plank (LR)',
      'L foot jump',
      '2 point plank (RL)',
      '2 foot jump',
      '4 point plank'
    ];

    var seconds = 30;

    function preventDefault(fn) {
      return function(e) {
        if (e) { e.preventDefault(); }
        fn();
      }
    }

    function main() {

      // Setup.

      var state = {
        running: false,
        time: seconds,
        currentExercise: 0
      };
      var timerTimeout = undefined;
      var $timer = $('.timer');
      var $exercise = $('.exercise');
      var $start = $('.start');
      var $stop = $('.stop');
      var $reset = $('.reset');

      $start.on('click', preventDefault(start));
      $stop.on('click', preventDefault(stop));
      $reset.on('click', preventDefault(reset));

      render(state);

      $(window).resize(resizeText);
      resizeText();


      // Functions.

      function dispatch(stateChange) {
        state = Object.assign({}, state, stateChange);
        render(state);
      }

      function tick() {
        var newState = {}
        if (state.time - 1 < 0) {
          // New exercise.
          newState.time = seconds;
          if (state.currentExercise + 1 >= exercises.length) {
            stop();
            return;
          }
          else {
            newState.currentExercise = state.currentExercise + 1;
            beep(100, 500);
          }
        }
        else {
          newState.time = state.time - 1;
          beep(100);
        }
        dispatch(newState);
        if (state.running) {
          timerTimeout = setTimeout(tick, 1000);
        }
      }

      function start() {
        dispatch({
          running: true
        });
        tick();
      }

      function stop() {
        dispatch({
          running: false
        });
        if (timerTimeout) {
          clearTimeout(timerTimeout);
          timerTimeout = undefined;
        }
      }

      function reset() {
        dispatch({
          running: false,
          time: seconds,
          currentExercise: 0
        });
      }

      function render(state) {
        $timer.text(state.time);
        $exercise.text(exercises[state.currentExercise] || '');
        if (state.running) {
          $start.attr('disabled', 'disabled');
          $stop.removeAttr('disabled');
          $reset.attr('disabled', 'disabled');
        }
        else {
          $start.removeAttr('disabled');
          $stop.attr('disabled', 'disabled');
          $reset.removeAttr('disabled');
        }
        resizeExercise();
      }

      function resizeText() {
        resizeTimer();
        resizeExercise();
      }

      function resizeTimer() {
        var timerContainerHeight = $timer.height();
        $timer.css({
          'font-size': timerContainerHeight * 0.9,
          'line-height': '' + timerContainerHeight + 'px'
        });
      }

      function resizeExercise() {
        var exerciseContainerHeight = $exercise.height();
        var exerciseContainerWidth = $exercise.width();
        var exerciseFontSize = exerciseContainerHeight * 0.8;
        $exercise.css({
          'font-size': exerciseFontSize,
          'line-height': '' + exerciseContainerHeight + 'px'
        });

        while ($exercise[0].scrollWidth > exerciseContainerWidth) {
          exerciseFontSize = exerciseFontSize - 2;
          $exercise.css('font-size', exerciseFontSize);
        }
      }

    }


    $(main);


    //All arguments are optional:
    //duration of the tone in milliseconds. Default is 500
    //frequency of the tone in hertz. default is 440
    //volume of the tone. Default is 1, off is 0.
    //type of tone. Possible values are sine, square, sawtooth, triangle, and custom. Default is sine.
    //callback to use on end of tone
    //if you have another AudioContext class use that one, as some browsers have a limit
    var audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);
    function beep(duration, frequency, volume, type, callback) {
        var oscillator = audioCtx.createOscillator();
        var gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (volume){gainNode.gain.value = volume;};
        if (frequency){oscillator.frequency.value = frequency;}
        if (type){oscillator.type = type;}
        if (callback){oscillator.onended = callback;}

        oscillator.start();
        setTimeout(function(){oscillator.stop()}, (duration ? duration : 500));
    };

  </script>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }
    body {
      text-align: center;
      font-family: sans-serif;
      font-size: 20px;
    }
    .container {
      position: fixed;
      width: 100%;
      height: 100%;
    }
    .buttons {
      font-size: 20px;
      position: absolute;
      top: 0;
      width: 100%;
      height: 25px;
    }
    .timer {
      font-size: 200px;
      line-height: 1em;
      position: absolute;
      top: 0;
      width: 100%;
      height: 60%;
      padding-top: 25px;
    }
    .exercise {
      font-size: 180px;
      line-height: 1.5em;
      position: absolute;
      top: 60%;
      width: 90%;
      left: 5%;
      height: 40%;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="timer"></div>
    <div class="exercise"></div>
    <div class="buttons">
      <button class="start">Start</button>
      <button class="stop">Stop</button>
      <button class="reset">Reset</button>
    </div>
  </div>
</body>
</html>
